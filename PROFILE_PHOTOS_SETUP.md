# Profile Photos Storage Setup

This guide walks you through setting up Supabase Storage for profile photos.

## Setup Steps

### 1. Create Storage Bucket

1. Go to your Supabase project dashboard
2. Navigate to **Storage** in the left sidebar
3. Click **New bucket**
4. Fill in the details:
   - **Name**: `profile-photos`
   - **Public bucket**: ✅ Enable (profile photos need to be publicly accessible)
   - **File size limit**: 5 MB (matches backend limit)
   - **Allowed MIME types**: Leave empty or specify:
     - `image/jpeg`
     - `image/jpg`
     - `image/png`
     - `image/webp`
     - `image/gif`

5. Click **Create bucket**

### 2. Configure Storage Policies

After creating the bucket, set up Row Level Security (RLS) policies:

#### Allow Authenticated Users to Upload Their Own Photos

```sql
-- Policy: Allow authenticated users to upload profile photos
CREATE POLICY "Users can upload their own profile photos"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'profile-photos' AND
  (storage.foldername(name))[1] = 'profile-photos'
);
```

#### Allow Public Read Access

```sql
-- Policy: Allow public read access to all profile photos
CREATE POLICY "Public read access for profile photos"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'profile-photos');
```

#### Allow Users to Update Their Own Photos

```sql
-- Policy: Users can update their own profile photos
CREATE POLICY "Users can update their own profile photos"
ON storage.objects FOR UPDATE
TO authenticated
USING (bucket_id = 'profile-photos')
WITH CHECK (bucket_id = 'profile-photos');
```

#### Allow Users to Delete Their Own Photos

```sql
-- Policy: Users can delete their own profile photos
CREATE POLICY "Users can delete their own profile photos"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'profile-photos');
```

### 3. Verify Setup

Test the storage setup by:

1. Upload a profile photo through the mobile app
2. Check that the image appears in the Storage browser under `profile-photos/`
3. Verify the image is accessible via the public URL
4. Try updating the profile photo
5. Verify the old photo is replaced or a new one is created

## File Organization

Profile photos are organized by filename:

```
profile-photos/
├── {userId}-{timestamp}.jpg
├── {userId}-{timestamp}.png
└── ...
```

Example:
```
profile-photos/
├── 550e8400-e29b-41d4-a716-446655440000-1699012345678.jpg
└── 550e8400-e29b-41d4-a716-446655440000-1699123456789.png
```

## Backend Integration

The backend automatically:
1. Accepts photo uploads via `/api/auth/upload-profile-photo`
2. Validates file type (images only) and size (max 5MB)
3. Uploads to Supabase Storage in `profile-photos` bucket
4. Generates unique filename: `{userId}-{timestamp}.{extension}`
5. Updates user profile with the public URL
6. Returns the photo URL to the mobile app

## Mobile App Integration

The mobile app:
1. Uses `expo-image-picker` to select photos
2. Allows 1:1 aspect ratio editing
3. Compresses images to 70% quality
4. Uploads via FormData with multipart/form-data
5. Updates the user store with new photo URL
6. Displays the new photo immediately

## Security Considerations

### File Validation
- Only image files are accepted (checked by backend)
- Maximum file size: 5MB
- File type validated by MIME type

### Access Control
- Upload: Only authenticated users can upload
- Read: Public read access (profile photos are meant to be public)
- Update/Delete: Only owners can modify their photos

### Photo URLs
- Public URLs are generated by Supabase
- URLs are permanent and do not expire
- Old photos remain in storage unless manually deleted

## Cleanup (Optional)

To keep storage clean, you can implement automatic cleanup of old photos:

```javascript
// Example: Delete old photo when new one is uploaded
const oldPhotoUrl = user.profile_photo_url;
if (oldPhotoUrl) {
  const oldPath = extractPathFromUrl(oldPhotoUrl);
  await supabase.storage.from('profile-photos').remove([oldPath]);
}
```

## Troubleshooting

### Error: "Failed to upload photo to storage"
- Check Supabase credentials in `.env`
- Verify bucket exists and is named `profile-photos`
- Check RLS policies are correctly configured

### Error: "Failed to update profile with photo URL"
- Verify `profiles` table has `profile_photo_url` column
- Check user authentication is working
- Verify RLS policies on `profiles` table

### Photos not displaying in app
- Check the public URL is correctly formed
- Verify bucket is set to public
- Check mobile app has internet connection

## Database Schema

Ensure the `profiles` table has the `profile_photo_url` column:

```sql
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS profile_photo_url TEXT;

-- Add comment
COMMENT ON COLUMN profiles.profile_photo_url IS 'Public URL of user profile photo from Supabase Storage';
```

## API Endpoint

**POST** `/api/auth/upload-profile-photo`

**Headers:**
```
Authorization: Bearer {jwt_token}
Content-Type: multipart/form-data
```

**Body (FormData):**
```
photo: <File> (image file)
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Profile photo uploaded successfully",
  "data": {
    "profile_photo_url": "https://xxx.supabase.co/storage/v1/object/public/profile-photos/userId-timestamp.jpg"
  }
}
```

**Response (Error):**
```json
{
  "error": "Upload failed",
  "message": "Failed to upload photo to storage"
}
```

## Mobile App Usage

```typescript
// Upload profile photo
const formData = new FormData();
formData.append('photo', {
  uri: imageUri,
  name: 'profile.jpg',
  type: 'image/jpeg',
} as any);

const response = await apiClient.post('/api/auth/upload-profile-photo', formData, {
  headers: {
    'Content-Type': 'multipart/form-data',
  },
});

if (response.data.success) {
  const photoUrl = response.data.data.profile_photo_url;
  // Update user store
  setUser({ ...user, profile_photo_url: photoUrl });
}
```

---

**Status:** ✅ Complete
**Last Updated:** 2025-11-25
